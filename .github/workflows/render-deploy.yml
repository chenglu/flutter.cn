name: Deploy to Render.com

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# Declare default permissions as read only.
permissions: 
  contents: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: 22

jobs:
  # éªŒè¯æ„å»ºï¼ˆPR å’Œ push éƒ½ä¼šè¿è¡Œï¼‰
  validate-build:
    name: Validate Render.com build
    runs-on: ubuntu-latest
    if: github.repository == 'chenglu/flutter.cn'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Enable Corepack
        run: npm i -g corepack@latest && corepack enable
      
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: Setup pnpm
        run: corepack install
      
      - uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c
        with:
          sdk: beta
      
      - name: Test build script
        run: |
          bash tool/build-render.sh
          echo "âœ… Build script executed successfully"
      
      - name: Verify build output
        run: |
          if [ ! -d "_site" ]; then
            echo "âŒ Error: _site directory not found"
            exit 1
          fi
          if [ ! -f "_site/index.html" ]; then
            echo "âŒ Error: index.html not found"
            exit 1
          fi
          if [ ! -f "_site/_redirects" ]; then
            echo "âš ï¸  Warning: _redirects file not found"
          fi
          if [ ! -f "_site/_headers" ]; then
            echo "âš ï¸  Warning: _headers file not found"
          fi
          echo "âœ… Build output verified"
      
      - name: Check build size
        run: |
          SIZE=$(du -sh _site | cut -f1)
          echo "ğŸ“¦ Build size: $SIZE"
          echo "build-size=$SIZE" >> $GITHUB_OUTPUT
      
      - name: Upload build artifacts (for debugging)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-debug
          path: |
            _site
            *.log
          retention-days: 7

  # éƒ¨ç½²é€šçŸ¥ï¼ˆä»…åœ¨ main åˆ†æ”¯ push æ—¶è¿è¡Œï¼‰
  deploy-notification:
    name: Render.com deployment status
    needs: validate-build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      github.repository == 'chenglu/flutter.cn'
    steps:
      - name: Notify deployment
        run: |
          echo "ğŸš€ Build validated successfully!"
          echo "ğŸ“¡ Render.com will automatically deploy from the main branch."
          echo "ğŸ”— Check deployment status at: https://dashboard.render.com"
          echo ""
          echo "If you haven't connected your repository to Render.com yet:"
          echo "1. Visit https://dashboard.render.com"
          echo "2. Create a new Static Site"
          echo "3. Connect this repository"
          echo "4. Render will use the render.yaml configuration"

  # PR é¢„è§ˆæç¤ºï¼ˆä»…åœ¨ PR æ—¶è¿è¡Œï¼‰
  pr-preview-info:
    name: PR preview information
    needs: validate-build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.repository == 'chenglu/flutter.cn'
    steps:
      - name: PR preview info
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.issue.number;
            // è·å– PR æ–‡ä»¶åˆ—è¡¨
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                per_page: 100
              }
            );
            // è¿‡æ»¤å‡º .md æ–‡ä»¶
            const mdFiles = files
              .map(f => f.filename)
              .filter(name => name.endsWith('.md'));

            let fileList = '';
            if (mdFiles.length > 0) {
              fileList = mdFiles.map(md => {
                const html = md.replace(/\.md$/, '.html');
                return `- [\`${md}\`](https://flutter-cn-docs-pr-${prNumber}.onrender.com/${html})`;
              }).join('\n');
            } else {
              fileList = '> æœ¬æ¬¡ PR æœªä¿®æ”¹ä»»ä½• Markdown æ–‡æ¡£ã€‚';
            }

            const message = `## ğŸ¨ Render.com PR æ–‡æ¡£é¢„è§ˆ >
            âœ… æ„å»ºå·²é€šè¿‡ï¼å·²è‡ªåŠ¨éƒ¨ç½²æœ¬æ¬¡ PR çš„æ–‡æ¡£é¢„è§ˆã€‚
            ### é¢„è§ˆé“¾æ¥ï¼ˆä»…åˆ—å‡ºæœ¬ PR ä¿®æ”¹çš„ Markdown æ–‡æ¡£ï¼‰ï¼š
            ${fileList}
            
            > é¢„è§ˆé“¾æ¥åœ¨æ„å»ºå®Œæˆåå‡ åˆ†é’Ÿå†…å¯è®¿é—®ã€‚

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
