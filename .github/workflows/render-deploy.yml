name: Deploy to Render.com

on:
  push:
    branches:
      - main
  pull_request_target:
    branches:
      - main
    types: [opened, synchronize, reopened]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# Declare default permissions as read only.
permissions: 
  contents: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: 22

jobs:
  # éªŒè¯æ„å»ºï¼ˆPR å’Œ push éƒ½ä¼šè¿è¡Œï¼‰
  validate-build:
    name: Validate Render.com build
    runs-on: ubuntu-latest
    if: github.repository == 'chenglu/flutter.cn'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Enable Corepack
        run: npm i -g corepack@latest && corepack enable
      
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: Setup pnpm
        run: corepack install
      
      - uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c
        with:
          sdk: beta
      
      - name: Test build script
        run: |
          bash tool/build-render.sh
          echo "âœ… Build script executed successfully"
      
      - name: Verify build output
        run: |
          if [ ! -d "_site" ]; then
            echo "âŒ Error: _site directory not found"
            exit 1
          fi
          if [ ! -f "_site/index.html" ]; then
            echo "âŒ Error: index.html not found"
            exit 1
          fi
          if [ ! -f "_site/_redirects" ]; then
            echo "âš ï¸  Warning: _redirects file not found"
          fi
          if [ ! -f "_site/_headers" ]; then
            echo "âš ï¸  Warning: _headers file not found"
          fi
          echo "âœ… Build output verified"
      
      - name: Check build size
        run: |
          SIZE=$(du -sh _site | cut -f1)
          echo "ğŸ“¦ Build size: $SIZE"
          echo "build-size=$SIZE" >> $GITHUB_OUTPUT
      
      - name: Upload build artifacts (for debugging)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-debug
          path: |
            _site
            *.log
          retention-days: 7
      
      # æˆåŠŸæ„å»ºåä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: _site
          retention-days: 1

  # éƒ¨ç½²é€šçŸ¥ï¼ˆä»…åœ¨ main åˆ†æ”¯ push æ—¶è¿è¡Œï¼‰
  deploy-notification:
    name: Render.com deployment status
    needs: validate-build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      github.repository == 'chenglu/flutter.cn'
    steps:
      - name: Notify deployment
        run: |
          echo "ğŸš€ æ„å»ºéªŒè¯æˆåŠŸï¼"
          echo "ğŸ“¡ Render.com å·²é€šè¿‡ GitHub é›†æˆè‡ªåŠ¨è§¦å‘éƒ¨ç½²"
          echo "ï¿½ ä¸»ç«™: https://flutter-cn-docs.onrender.com"
          echo "ï¿½ æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: https://dashboard.render.com"

  # PR é¢„è§ˆä¿¡æ¯ï¼ˆä»…åœ¨ PR æ—¶è¿è¡Œï¼‰
  pr-preview-info:
    name: PR preview information
    needs: validate-build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request_target' &&
      github.repository == 'chenglu/flutter.cn'
    steps:
      - name: PR preview info
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.issue.number;
            // è·å– PR æ–‡ä»¶åˆ—è¡¨
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                per_page: 100
              }
            );
            // è¿‡æ»¤å‡º .md æ–‡ä»¶
            const mdFiles = files
              .map(f => f.filename)
              .filter(name => name.endsWith('.md'));

            let fileList = '';
            if (mdFiles.length > 0) {
              fileList = mdFiles.map(md => {
                const html = md.replace(/\.md$/, '.html');
                return `- [\`${md}\`](https://flutter-cn-docs-pr-${prNumber}.onrender.com/${html})`;
              }).join('\n');
            } else {
              fileList = '> æœ¬æ¬¡ PR æœªä¿®æ”¹ä»»ä½• Markdown æ–‡æ¡£ã€‚';
            }

            const message = `## ğŸ¨ Render.com PR æ–‡æ¡£é¢„è§ˆ
            
            âœ… æ„å»ºéªŒè¯å·²é€šè¿‡ï¼
            
            ### ğŸ”— PR é¢„è§ˆé“¾æ¥ï¼š
            https://flutter-cn-docs-pr-${prNumber}.onrender.com
            
            ### ğŸ“ æœ¬æ¬¡ PR ä¿®æ”¹çš„ Markdown æ–‡æ¡£ï¼š
            ${fileList}
            
            ---
            
            ğŸ’¡ **é¢„è§ˆè¯´æ˜ï¼š**
            - Render.com ä¼šé€šè¿‡ GitHub é›†æˆè‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½² PR é¢„è§ˆ
            - é¢„è§ˆé“¾æ¥é€šå¸¸åœ¨å‡ åˆ†é’Ÿå†…ç”Ÿæ•ˆï¼ˆé¦–æ¬¡å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
            - æ¯æ¬¡æ¨é€æ–° commit éƒ½ä¼šè‡ªåŠ¨è§¦å‘é‡æ–°éƒ¨ç½²
            - å¦‚æœé¢„è§ˆé“¾æ¥æš‚æ—¶æ— æ³•è®¿é—®ï¼Œè¯·ç­‰å¾… Render.com å®Œæˆéƒ¨ç½²
            
            ğŸš€ é¢„è§ˆå°†è‡ªåŠ¨éƒ¨ç½²å®Œæˆï¼`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
